// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../lib/generated/prisma"
}

datasource db {
  provider = "postgresql"
}


model User {
  id        Int      @id @default(autoincrement())
  loginId   String   @unique
  password  String
  role      Role     @default(OPERATOR)
  name      String
  email     String?
  createdAt DateTime @default(now())
}

enum Role {
  SUPER_ADMIN
  ADMIN
  OPERATOR
  FINANCE
  DOCUMENTOR
}

model Customer {
  id              String         @id @default(cuid())        // Internal primary key
  customerCode    String         @unique                     // Example: "CUST-001"
  companyName     String
  type            CustomerType  
  contactPerson   String
  phone           String?
  email           String         @unique  
  address         String?
  city            String?
  country         String  
  currency        String         @default("INR")  
  creditLimit     Float          @default(0)
  usedCredits     Float          @default(0)
  totalAmount     Float          @default(0)  
  paymentTerms    String?        // Example: "Net 30"  
  kycStatus       Boolean        @default(false)
  sanctionsCheck  Boolean        @default(false)
  status          CustomerStatus @default(ACTIVE)           // <-- Added enum field
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  shipments  Shipment[]
}

enum CustomerType {
  Importer
  Distributor
  RetailChain
  RestaurantGroup
}

enum CustomerStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

model Port {
  id        Int      @id @default(autoincrement())
  code      String   @unique
  city      String
  country   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  originShipments      Shipment[] @relation("OriginPort")
  destinationShipments Shipment[] @relation("DestinationPort")
}

model Incoterm {
  id        Int      @id @default(autoincrement())
  code      String   @unique
  name      String
  type      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  shipments Shipment[]
}

model StatusCode {
  id          Int      @id @default(autoincrement())
  code        String   @unique
  description String
  stage       String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Currency {
  id            Int      @id @default(autoincrement())
  currencyCode  String   @unique
  name          String
  exchangeRate  Float    // EXCHANGE RATE TO INR
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  shipments Shipment[]
  products  Product[]
}

model Temperature {
  id         Int      @id @default(autoincrement())
  name       String
  range      String
  tolerance  String
  setPoint   Float?          // ✅ added
  unit       TemperatureUnit @default(C) // ✅ added
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  shipments  Shipment[]
  categories Category[]
  products   Product[]
}

enum StorageType {
  AMBIENT
  CHILLED
  FROZEN
}

model Category {
  id          String      @id                 // e.g. "CAT-001"
  name        String
  hsCode      String?
  storageType StorageType @default(AMBIENT)
  documents   String?
  notes       String?
  temperatureId Int?
  temperature   Temperature? @relation(fields: [temperatureId], references: [id], onDelete: Restrict)

  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

   products    Product[]

  @@index([name])
  @@index([temperatureId])
  @@map("categories")
  
}
enum ProductType {
  FROZEN
  SPICE
}

model Product {
  id             String      @id                 // e.g. "PROD-001"
  name           String
  type           ProductType

  hsCode         String?
  packSize       String?
  shelfLife      String?
  unitsPerCarton Int?
  cartonsPerPallet Int?
  notes          String?
  unitPrice        Float?
  currencyCode     String      @default("INR")     // ex: INR, USD, AED
  currency         Currency    @relation(fields: [currencyCode], references: [currencyCode], onDelete: Restrict)
 
  temperatureId Int?
  temperature   Temperature? @relation(fields: [temperatureId], references: [id], onDelete: Restrict)

  categoryId     String
  category       Category    @relation(fields: [categoryId], references: [id], onDelete: Restrict)
  shipmentItems    ShipmentItem[]

  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt

  @@index([name])
  @@index([categoryId])
  @@index([temperatureId])
  @@map("products")

}
enum TransportMode {
  AIR
  SEA
  ROAD
}

enum WeightUnit {
  MANN        // Mann / Maund
  KG          // Kilogram
  QUINTAL     // Quintal (q)
  TON         // Metric Ton (t)
  LB          // Pounds
}

model ContainerType {
  id            Int           @id @default(autoincrement())
  code          String        @unique
  name          String
  transportMode TransportMode
  type          String

  maxWeight     Float?
  weightUnit    WeightUnit    @default(KG)

  status        Boolean       @default(true)
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  shipments Shipment[]
}


enum ShipmentDirection {
  IMPORT
  EXPORT
}

enum ShipmentCommodity {
  FROZEN
  SPICE
  BOTH
  OTHER
}

enum ShipmentStatus {
  BOOKED
  PICKED_UP
  IN_TRANSIT_ORIGIN
  AT_PORT_ORIGIN
  CUSTOMS_EXPORT
  ON_VESSEL
  AT_PORT_DEST
  CUSTOMS_IMPORT
  DELIVERED
  EXCEPTION
}

enum SLAStatus {
  ON_TIME
  AT_RISK
  BREACHED
}

enum InvoiceStatus {
  DRAFT
  SENT
  PAID
  OVERDUE
}

enum TemperatureUnit {
  C
  F
}

enum ShipmentDocumentType {
  INVOICE
  PACKING_LIST
  BILL_LADING
  HEALTH_CERT
  ORIGIN_CERT
  CUSTOMS_DEC
  INSURANCE
  OTHER
}

enum ShipmentDocumentStatus {
  MISSING
  DRAFT
  SUBMITTED
  APPROVED
  REJECTED
  FINAL
  PENDING
  NOT_RECEIVED
}
model Shipment {
  id            String            @id @default(cuid())

  reference     String            @unique
  masterDoc     String?

  customerId    String
  customer      Customer          @relation(fields: [customerId], references: [id], onDelete: Restrict)

  direction     ShipmentDirection
  mode          TransportMode
  commodity     ShipmentCommodity

  incotermId    Int?
  incoterm      Incoterm?         @relation(fields: [incotermId], references: [id], onDelete: Restrict)

  // Origin
  originCity      String
  originCountry   String
  originContact   String?
  originPortId    Int?
  originPort      Port?           @relation("OriginPort", fields: [originPortId], references: [id], onDelete: Restrict)

  // Destination
  destCity        String
  destCountry     String
  destContact     String?
  destPortId      Int?
  destPort        Port?           @relation("DestinationPort", fields: [destPortId], references: [id], onDelete: Restrict)

  // Step 3
  containerTypeId Int?
  containerType   ContainerType?  @relation(fields: [containerTypeId], references: [id], onDelete: Restrict)

  temperatureId   Int?
  temperature     Temperature?    @relation(fields: [temperatureId], references: [id], onDelete: Restrict)

  // Step 4
  status        ShipmentStatus     @default(BOOKED)
  etd           DateTime?
  eta           DateTime?

  slaStatus     SLAStatus          @default(ON_TIME)

  currencyId   Int?
  currency      Currency?          @relation(fields: [currencyId], references: [id], onDelete: Restrict)
  revenue       Float              @default(0)
  cost          Float              @default(0)
  margin        Float              @default(0)
  invoiceStatus InvoiceStatus      @default(DRAFT)
  vehicleId  String?
  vehicle    Vehicle? @relation(fields: [vehicleId], references: [id], onDelete: Restrict)
  driverId      String?
  driver        Driver?            @relation(fields: [driverId], references: [id], onDelete: Restrict)

  items         ShipmentItem[]
  documents     ShipmentDocument[]
  events        ShipmentEvent[]

  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt

  @@index([customerId])
  @@index([reference])
  @@index([mode])
  @@index([direction])
  @@index([vehicleId])
  @@index([driverId])
}

model ShipmentItem {
  id         String   @id @default(cuid())

  shipmentId String
  shipment   Shipment @relation(fields: [shipmentId], references: [id], onDelete: Cascade)

  productId  String
  product    Product  @relation(fields: [productId], references: [id], onDelete: Restrict)

  quantity   Int
  unit       String
  weightKg   Float?
  packaging  String?

  createdAt  DateTime @default(now())

  @@index([shipmentId])
  @@index([productId])
}

model ShipmentDocument {
  id         String                @id @default(cuid())

  shipmentId String
  shipment   Shipment              @relation(fields: [shipmentId], references: [id], onDelete: Cascade)

  name       String
  type       ShipmentDocumentType
  status     ShipmentDocumentStatus @default(DRAFT)

  expiryDate DateTime?
  uploadedAt DateTime              @default(now())

  fileUrl    String?
  mimeType   String?
  fileSize   Int?

  @@index([shipmentId])
  @@index([type])
  @@index([status])
}

model ShipmentEvent {
  id          String         @id @default(cuid())

  shipmentId  String
  shipment    Shipment       @relation(fields: [shipmentId], references: [id], onDelete: Cascade)

  status      ShipmentStatus
  timestamp   DateTime       @default(now())
  location    String?
  description String?
  user        String?

  @@index([shipmentId])
  @@index([status])
}

enum VehicleOwnership {
  OWN
  RENT
}

enum FuelType {
  PETROL
  DIESEL
  CNG
  LPG
  ELECTRIC
  OTHER
}

enum DriverRole {
  DRIVER
  OPERATOR
}

model FreightMode {
  // Uses same enum values ROAD/SEA/AIR
  id        TransportMode @id
  label     String
  enabled   Boolean       @default(true)

  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  @@map("freight_modes")
}

model Vehicle {
  id              String           @id // e.g. "VEH-001"
  name            String
  number          String           @unique
  ownership       VehicleOwnership @default(OWN)

  engineType      String?
  fuel            FuelType         @default(DIESEL)
  fuelOther       String?
  fuelCapacity    Float?
  loadingCapacity Float?

  rcNumber        String?
  rcExpiry        DateTime?
  pollutionExpiry DateTime?

  isRegistered    Boolean          @default(true)
  registeredAt    DateTime?

  docs            String?
  transportMode   TransportMode

  managingVehicle String?          // manager name / team / vendor
  medicalSupport  String?          // e.g. "First Aid Kit", "Doctor on call", etc.
  notes           String?

  drivers         VehicleDriver[]
  shipments       Shipment[]

  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  @@index([name])
  @@index([transportMode])
  @@map("vehicles")
}

model Driver {
  id               String      @id // e.g. "DRV-001"
  name             String
  age              Int?
  role             DriverRole  @default(DRIVER)

  profession       String?
  education        String?
  languages        String?     // comma separated: "English, Telugu"
  licenseNumber    String?
  contactNumber    String?
  email            String?
  address          String?

  transportMode    TransportMode
  medicalCondition String?
  notes            String?

  vehicles         VehicleDriver[]
  shipments        Shipment[]

  createdAt        DateTime    @default(now())
  updatedAt        DateTime    @updatedAt

  @@index([name])
  @@index([transportMode])
  @@map("drivers")
}

model VehicleDriver {
  vehicleId  String
  driverId   String
  assignedAt DateTime @default(now())

  vehicle    Vehicle @relation(fields: [vehicleId], references: [id], onDelete: Cascade)
  driver     Driver  @relation(fields: [driverId], references: [id], onDelete: Cascade)

  @@id([vehicleId, driverId])
  @@index([driverId])
  @@map("vehicle_drivers")
}
